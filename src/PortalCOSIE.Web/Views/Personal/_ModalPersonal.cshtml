<!-- Modal para Crear/Editar personal -->
<div class="modal fade" id="modalPersonal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form id="formPersonal" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="identityUserId" name="identityUserId" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <fieldset class="border rounded px-3 mb-3">
                        <legend class="float-none w-auto px-2 text-primary fs-6">
                            <i class="fas fa-user-circle me-2"></i>Datos personales
                        </legend>
                        <div class="row mb-4">
                            <div class="col-lg-4 col-md-4">
                                <label for="nombre" class="form-label">Nombre:</label>
                                <input type="text" id="nombre" name="nombre" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>

                            <div class="col-lg-4 col-md-4">
                                <label for="apellidoPaterno" class="form-label">Apellido paterno:</label>
                                <input type="text" id="apellidoPaterno" name="apellidoPaterno" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>

                            <div class="col-lg-4 col-md-4">
                                <label for="apellidoMaterno" class="form-label">Apellido materno:</label>
                                <input type="text" id="apellidoMaterno" name="apellidoMaterno" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button id="btnModalPersonal" type="submit" class="btn btn-primary">
                        <i id="btnIcon" class="fas fa-save me-2"></i><span></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function inicializarModalPersonal() {
        const MODOS = {
            crear: {
                titulo: 'Crear personal',
                btnTexto: 'Enviar correo',
                action: '@Url.Action("Crear", "Personal")'
            },
            editar: {
                titulo: 'Editar personal',
                btnTexto: 'Guardar cambios',
                action: '@Url.Action("Editar", "Personal")'
            }
        };

        const modal = document.getElementById('modalPersonal');
        const form = modal.querySelector('#formPersonal');
        const btnSubmit = form.querySelector('button[type="submit"]');
        const btnIcon = btnSubmit.querySelector('i');
        const btnText = btnSubmit.querySelector('span');

        // Estado original del botón
        const btnOriginalState = {
            iconClass: btnIcon.className,
            text: '' // se setea según el modo
        };

        // Funciones para bloquear/restaurar botón
        const bloquearBoton = () => {
            btnIcon.className = 'fas fa-spinner fa-spin me-2';
            btnText.textContent = 'Cargando...';
            btnSubmit.disabled = true;
        };

        const restaurarBoton = () => {
            btnIcon.className = btnOriginalState.iconClass;
            btnText.textContent = btnOriginalState.text;
            btnSubmit.disabled = false;
        };

        // Configurar modal según modo
        const configurarModal = (modo, data = {}) => {
            const config = MODOS[modo];

            // Resetear formulario
            form.reset();

            // Configurar título y botón
            modal.querySelector('.modal-title').textContent = config.titulo;
            btnText.textContent = config.btnTexto;
            form.action = config.action;
            btnOriginalState.text = config.btnTexto;

            restaurarBoton();

            // Llenar datos si es edición
            if (modo === 'editar') {
                form.querySelector('input[name="identityUserId"]').value = data.userid || '';
                form.querySelector('#nombre').value = data.nombre || '';
                form.querySelector('#apellidoPaterno').value = data.apellidopaterno || '';
                form.querySelector('#apellidoMaterno').value = data.apellidomaterno || '';
            }
        };

        // Evento botones crear/editar usando delegation
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-mode]');
            if (!btn) return;

            const modo = btn.dataset.mode === 'create' ? 'crear' : 'editar';
            configurarModal(modo, btn.dataset);
        });

        // Limpiar al cerrar modal
        modal.addEventListener('hidden.bs.modal', () => {
            form.reset();
            form.querySelector('input[name="identityUserId"]').value = '';
            restaurarBoton();
        });

        // Submit del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            bloquearBoton();
            try {
                const url = form.action;
                const formData = new FormData(form);
                const resultado = await executeFetch(url, 'POST', formData);

                // Cerrar modal
                if (bootstrap?.Modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
                    bsModal.hide();
                }
                showGlobalModal('success', resultado.message);
                form.reset();
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: restaurarBoton
                });
            }
        });
    }
</script>
