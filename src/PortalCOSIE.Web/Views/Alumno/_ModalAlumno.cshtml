<!-- Modal para Crear/Editar alumno -->
<div class="modal fade" id="modalAlumno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form id="formAlumno" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="identityUserId" name="identityUserId" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <fieldset class="border rounded px-3 mb-3">
                        <legend class="float-none w-auto px-2 text-primary fs-6">
                            <i class="fas fa-user-circle me-2"></i>Datos personales
                        </legend>
                        <div class="row mb-4">
                            <div class="col-lg-4 col-md-4">
                                <label for="nombre" class="form-label">Nombre:</label>
                                <input type="text" id="nombre" name="nombre" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>

                            <div class="col-lg-4 col-md-4">
                                <label for="apellidoPaterno" class="form-label">Apellido paterno:</label>
                                <input type="text" id="apellidoPaterno" name="apellidoPaterno" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>

                            <div class="col-lg-4 col-md-4">
                                <label for="apellidoMaterno" class="form-label">Apellido materno:</label>
                                <input type="text" id="apellidoMaterno" name="apellidoMaterno" class="form-control"
                                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑüÜ\s]+"
                                       required>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border rounded px-3 mb-3">
                        <legend class="float-none w-auto px-2 text-primary fs-6">
                            <i class="fas fa-graduation-cap me-2"></i>Datos académicos
                        </legend>
                        <div class="row mb-3">
                            <div class="col-lg-4 col-md-4">
                                <label for="numeroBoleta" class="form-label">No. de boleta:</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-id-card"></i>
                                    </span>
                                    <input type="text" id="numeroBoleta" name="numeroBoleta" class="form-control" required
                                           placeholder="Ej. 2020640595"
                                           maxlength="10"
                                           pattern="\d*"
                                           oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <label for="carreraId" class="form-label">Carrera:</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-university"></i>
                                    </span>
                                    <select asp-items="ViewBag.Carreras" id="carreraId" name="carreraId" class="form-select" required>
                                        <option value="">- Carrera -</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <label for="periodoIngreso" class="form-label">Periodo ingreso:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                    <select asp-items="ViewBag.Periodos" id="periodoIngreso" name="periodoIngreso" class="form-select" required>
                                        <option value="">- Periodo ingreso -</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="modal-footer justify-content-between">
                    @* <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>Los cambios serán notificados vía correo
                    </div> *@
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i id="btnIcon" class="fas fa-save me-2"></i><span></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('modalAlumno');
        const form = document.getElementById('formAlumno');
        const modalTitle = document.getElementById('modalTitle');
        const btnSubmit = form.querySelector('button[type="submit"]');
        const btnIcon = btnSubmit.querySelector('i');
        const btnText = btnSubmit.querySelector('span');
        const boton = bloqueadorBoton(btnSubmit);

        const MODOS = {
            crear: {
                titulo: 'Crear alumno',
                btnTexto: 'Enviar correo',
                action: form.dataset.createAction || '@Url.Action("Crear", "Alumno")'
            },
            editar: {
                titulo: 'Editar alumno',
                btnTexto: 'Guardar cambios',
                action: form.dataset.editAction || '@Url.Action("Editar", "Alumno")'
            }
        };

        // Mapeo del formulario
        const campos = {
            identityUserId: form.querySelector('#identityUserId'),
            nombre: form.querySelector('#nombre'),
            apellidoPaterno: form.querySelector('#apellidoPaterno'),
            apellidoMaterno: form.querySelector('#apellidoMaterno'),
            numeroBoleta: form.querySelector('#numeroBoleta'),
            carreraId: form.querySelector('#carreraId'),
            periodoIngreso: form.querySelector('#periodoIngreso')
        };

        const limpiarFormulario = () => {
            form.reset();
            campos.identityUserId.value = '';
        };

        const configurarModal = (modo, data = {}) => {
            const config = MODOS[modo];

            if (!config) {
                console.error(`Modo inválido: ${modo}`);
                return;
            }

            // Limpiar formulario
            limpiarFormulario();

            // Configurar título y acción
            modalTitle.textContent = config.titulo;
            form.action = config.action;

            // Configurar botón submit
            btnText.textContent = config.btnTexto;
            btnIcon.className = 'fas fa-save me-2';
            btnSubmit.disabled = false;

            // Llenar datos en modo edición
            if (modo === 'editar') {
                campos.identityUserId.value = data.userid || '';
                campos.nombre.value = data.nombre || '';
                campos.apellidoPaterno.value = data.apellidopaterno || '';
                campos.apellidoMaterno.value = data.apellidomaterno || '';
                campos.numeroBoleta.value = data.numeroboleta || '';
                campos.carreraId.value = data.carreraid || '';
                campos.periodoIngreso.value = data.periodoingreso || '';
            }
        };

        // ========= REGISTRO DE EVENTOS =========
        // Abrir modal (delegación de eventos)
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-mode]');
            if (!btn) return;

            const modo = btn.dataset.mode === 'create' ? 'crear' : 'editar';
            configurarModal(modo, btn.dataset);
        });

        // Submit del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            boton.bloquear();
            try {
                const url = form.action;
                const formData = new FormData(form);
                const resultado = await executeFetch(url, 'POST', formData);
                showGlobalModal('success', resultado.message);
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });

        // Limpiar al cerrar modal
        modal.addEventListener('hidden.bs.modal', () => {
            limpiarFormulario();
            boton.restaurar();
        });
    });
</script>
