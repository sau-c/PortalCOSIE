<div class="chart-card card shadow h-100">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="mb-0 py-1 text-truncate" title="Top 10 unidades mas reprobadas por periodo de solicitud CTCE">
            Top 10 unidades más reprobadas
        </h6>

        <div class="d-flex gap-2">
            <select asp-items="ViewBag.Carreras"
                    id="filtroReprobadas"
                    name="carreraId"
                    class="form-select form-select-sm"
                    aria-label="Filtrar por carrera">
                <option value="">Todas las carreras</option>
            </select>

            <select asp-items="ViewBag.Periodos"
                    id="filtroReprobadasPeriodo"
                    name="periodo"
                    class="form-select form-select-sm"
                    aria-label="Filtrar por periodo">
            </select>
        </div>
    </div>

    <div class="card-body position-relative">
        <div class="chart-container" style="height: 300px;">
            <canvas id="chartMasReprobadas"></canvas>
        </div>

        <div id="loaderReprobadas"
             class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
             style="background: rgba(255,255,255,0.7); z-index: 10;">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>
</div>

<script>
    (function () {
        // Cacheo de elementos del DOM
        const elements = {
            ctx: document.getElementById('chartMasReprobadas'),
            selectCarrera: document.getElementById('filtroReprobadas'),
            selectPeriodo: document.getElementById('filtroReprobadasPeriodo'),
            loader: document.getElementById('loaderReprobadas')
        };

        let chartInstance = null;

        // Configuración del gráfico separada para mayor limpieza
        const getChartConfig = (labels, data) => ({
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Solicitudes',
                    data: data,
                    backgroundColor: 'rgba(139, 0, 0, 0.8)', // Darkred con transparencia
                    borderColor: 'darkred',
                    borderWidth: 1,
                    borderRadius: 4,
                    barThickness: 20, // Un poco más grueso para legibilidad
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => ` ${context.raw} Solicitudes`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0' },
                        ticks: { precision: 0 }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });

        async function cargarDatos() {
            if (!elements.ctx) return;

            toggleLoader(true);

            try {
                const carreraId = elements.selectCarrera.value;
                const periodo = elements.selectPeriodo.value;

                // Aseguramos que la URL maneje strings vacíos correctamente
                const params = new URLSearchParams({
                    carreraId: carreraId || '',
                    periodo: periodo || ''
                });

                const url = `/Dashboard/MasReprobadas?${params.toString()}`;

                // Asumo que executeFetch existe en tu entorno global
                const response = await executeFetch(url, 'GET');

                // Validación defensiva de la respuesta
                const labels = response?.data?.labels || [];
                const values = response?.data?.values || [];

                renderChart(labels, values);

            } catch (error) {
                console.error("Error cargando gráfica:", error);
                if (typeof showGlobalModal === 'function') {
                    showGlobalModal('error', 'No se pudieron cargar los datos de reprobación.');
                }
            } finally {
                toggleLoader(false);
            }
        }

        function renderChart(labels, values) {
            if (chartInstance) {
                // Actualización optimizada
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.update();
            } else {
                // Primera carga
                chartInstance = new Chart(elements.ctx, getChartConfig(labels, values));
            }
        }

        function toggleLoader(isVisible) {
            if (!elements.loader) return;

            if (isVisible) {
                elements.loader.classList.remove('d-none');
            } else {
                elements.loader.classList.add('d-none');
            }
        }

        function init() {
            // Verificar que los elementos existan antes de asignar eventos
            if (elements.selectCarrera && elements.selectPeriodo) {

                // 1. Evento para Carrera
                elements.selectCarrera.addEventListener('change', cargarDatos);

                // 2. Evento para Periodo (EL QUE FALTABA)
                elements.selectPeriodo.addEventListener('change', cargarDatos);

                // Carga inicial
                cargarDatos();
            }
        }

        // Ejecutar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    })();
</script>