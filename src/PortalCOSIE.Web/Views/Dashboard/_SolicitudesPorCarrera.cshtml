<div class="chart-card card shadow h-100" id="cardSolicitudesPorCarrera">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 py-1">Solicitud CTCE por carrera</h6>
        
        <select id="filtroSolicitudesCarreras" class="form-select form-select-sm w-auto">
            <option value="6">Últimos 6 meses</option>
            <option value="3">Últimos 3 meses</option>
            <option value="12">Este año</option>
        </select>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="chartSolicitudesPorCarrera"></canvas>
        </div>
        <div id="loaderCarreras" class="text-center d-none" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%)">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>
</div>

<script>
    (function () {
        let chartInstance = null;
        const ctx = document.getElementById('chartSolicitudesPorCarrera');
        const selectFiltro = document.getElementById('filtroSolicitudesCarreras');
        const loader = document.getElementById('loaderCarreras');

        // Configuración estática del gráfico (Separada de los datos)
        const chartConfig = {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#5A1236', '#85CB33', '#FF6B35', '#FFC107', '#1391FF'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 14 },
                        formatter: (value, ctx) => {
                            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        };

        // Función principal de carga
        async function cargarDatos() {
            if (!ctx) return; // Protección si el elemento no existe

            mostrarLoader(true);
            try {
                const rango = selectFiltro.value;
                const url = `/Dashboard/SolicitudesPorCarrera?rango=${rango}`;
                const response = await executeFetch(url, 'GET');
                // const data = await response.json();
                actualizarGrafico(response.data.labels, response.data.values);
                mostrarLoader(false);
            } catch (error) {
                showGlobalModal('error', error.message);
                mostrarLoader(false);
            }
        }
        
        function actualizarGrafico(labels, values) {
            // Si no existe, lo creamos
            if (!chartInstance) {
                chartConfig.data.labels = labels;
                chartConfig.data.datasets[0].data = values;
                chartInstance = new Chart(ctx, chartConfig);
            } else {
                // Si existe, solo actualizamos los datos
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.update();
            }
        }

        function mostrarLoader(visible) {
            if (!loader) return;
            if (visible) {
                loader.classList.remove('d-none');
                ctx.style.opacity = 0.3;
            } else {
                loader.classList.add('d-none');
                ctx.style.opacity = 1;
            }
        }

        // Inicialización (Event Listeners)
        document.addEventListener('DOMContentLoaded', () => {
            if (selectFiltro) {
                selectFiltro.addEventListener('change', cargarDatos);
                // Carga inicial
                cargarDatos();
            }
        });
    })();
</script>
