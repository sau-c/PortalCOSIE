<div class="modal fade" id="modalSesion" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formSesion" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" />

                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="numeroSesion" class="form-label fw-semibold">No. de sesión</label>
                            <input type="text" class="form-control" id="numeroSesion" name="NumeroSesion" required>
                        </div>

                        <div class="col-md-6">
                            <label for="fechaSesion" class="form-label fw-semibold">Fecha de sesión</label>
                            <input type="date" class="form-control" id="fechaSesion" name="FechaSesion" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fechas de recepción documental</label>
                        <div class="fechas-container"></div>
                        <button type="button" class="btn btn-sm btn-outline-success mt-2 btn-agregar-fecha">
                            <i class="fas fa-plus me-1"></i>Agregar fecha
                        </button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        <span></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function inicializarModalSesion() {
        const $modal = $('#modalSesion');
        const $form = $modal.find('#formSesion');
        const $fechasContainer = $modal.find('.fechas-container');

        // Configuración de modos
        const MODOS = {
            crear: {
                titulo: 'Crear nueva sesión',
                btnTexto: 'Crear',
                action: '@Url.Action("CrearSesionCOSIE", "Home")'
            },
            editar: {
                titulo: 'Editar sesión',
                btnTexto: 'Guardar',
                action: '@Url.Action("EditarSesionCOSIE", "Home")'
            }
        };

        // Formatear fecha a YYYY-MM-DD
        const formatearFecha = (fecha) => {
            if (!fecha) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
            const date = new Date(fecha);
            return isNaN(date) ? null : date.toISOString().split('T')[0];
        };

        // Agregar campo de fecha
        const agregarCampoFecha = (valor = '') => {
            const $campo = $(`
                <div class="input-group mb-2 fecha-item">
                    <input type="date" class="form-control" name="fechasRecepcion" value="${valor}">
                    <button type="button" class="btn btn-outline-danger btn-remover-fecha">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            $fechasContainer.append($campo);
        };

        // Abrir modal (crear o editar)
        $(document).on('click', '.btn-crear, .btn-editar', function() {
            const $btn = $(this);
            const modo = $btn.data('mode');
            const config = MODOS[modo];
            const esCrear = modo === 'crear';

            // Limpiar y configurar modal
            $fechasContainer.empty();
            $form[0].reset();
            $modal.find('.modal-title').text(config.titulo);
            $modal.find('button[type="submit"] span').text(config.btnTexto);
            $form.attr('action', config.action);

            // Llenar datos si es edición
            if (!esCrear) {
                $form.find('input[name="id"]').val($btn.data('id'));
                $('#numeroSesion').val($btn.data('numero-sesion'));
                $('#fechaSesion').val($btn.data('fecha-sesion'));

                // Cargar fechas de recepción
                const fechasRecepcion = $btn.data('fechas-recepcion') || [];
                fechasRecepcion.forEach(fecha => {
                    const fechaFormateada = formatearFecha(fecha);
                    if (fechaFormateada) agregarCampoFecha(fechaFormateada);
                });
            }
        });

        // Agregar fecha de recepción
        $modal.on('click', '.btn-agregar-fecha', () => agregarCampoFecha());

        // Remover fecha
        $modal.on('click', '.btn-remover-fecha', function() {
            $(this).closest('.fecha-item').remove();
        });

        // Submit del formulario
        $form.on('submit', function(e) {
            // Aquí puedo agregar validación perzonalzada para frontend
            // e.preventDefault()
            return true;
        });
    }
</script>