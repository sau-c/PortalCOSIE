<div class="modal fade" id="modalSesion" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formSesion" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" />

                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="numeroSesion" class="form-label fw-semibold">No. de sesión</label>
                            <input type="text" class="form-control" id="numeroSesion" name="NumeroSesion" required>
                        </div>

                        <div class="col-md-6">
                            <label for="fechaSesion" class="form-label fw-semibold">Fecha de sesión</label>
                            <input type="date" class="form-control" id="fechaSesion" name="FechaSesion" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fechas de recepción documental</label>
                        <div class="fechas-container"></div>
                        <button type="button" class="btn btn-sm btn-outline-success mt-2 btn-agregar-fecha">
                            <i class="fas fa-plus me-1"></i>Agregar fecha
                        </button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        <span>Guardar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("modalSesion");
        const form = document.getElementById("formSesion");
        const fechasContainer = modal.querySelector(".fejas-container") ?? modal.querySelector(".fechas-container");
        const submitBtn = form.querySelector('button[type="submit"]');
        const boton = bloqueadorBoton(submitBtn);

        const MODOS = {
            crear: {
                titulo: "Crear nueva sesión",
                action: "@Url.Action("CrearSesionCOSIE", "Calendario")"
            },
            editar: {
                titulo: "Editar sesión",
                action: "@Url.Action("EditarSesionCOSIE", "Calendario")"
            }
        };

        // ========= UTILIDADES =========
        const formatearFecha = (fecha) => {
            if (!fecha) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;

            const d = new Date(fecha);
            return isNaN(d) ? null : d.toISOString().split("T")[0];
        };

        function crearCampoFecha(valor = "") {
            const div = document.createElement("div");
            div.className = "input-group mb-2 fecha-item";
            div.innerHTML = `
                <input type="date" class="form-control" name="fechasRecepcion" value="${valor}">
                <button type="button" class="btn btn-outline-danger btn-remover-fecha">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fechasContainer.appendChild(div);
        }

        // ========= EVENTO: ABRIR MODAL =========
        document.addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-crear, .btn-editar");
            if (!btn) return;

            const modo = btn.dataset.mode;
            const config = MODOS[modo];
            const esCrear = modo === "crear";

            // Reset Visual
            fechasContainer.innerHTML = "";
            form.reset();

            // Configurar modal
            modal.querySelector(".modal-title").textContent = config.titulo;
            form.setAttribute("action", config.action);

            if (!esCrear) {
                form.querySelector('input[name="id"]').value = btn.dataset.id;
                form.querySelector("#numeroSesion").value = btn.dataset.numeroSesion;
                form.querySelector("#fechaSesion").value = btn.dataset.fechaSesion;

                const fechas = JSON.parse(btn.dataset.fechasRecepcion || "[]");
                fechas.forEach(f => {
                    const formatted = formatearFecha(f);
                    if (formatted) crearCampoFecha(formatted);
                });
            }
        });

        // ========= AGREGAR FECHAS =========
        modal.addEventListener("click", (e) => {
            if (e.target.closest(".btn-agregar-fecha")) {
                crearCampoFecha();
            }
        });

        // ========= REMOVER FECHAS =========
        modal.addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-remover-fecha");
            if (btn) btn.closest(".fecha-item").remove();
        });


        // ========= SUBMIT =========
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            boton.bloquear();

            try {
                const url = form.getAttribute("action");
                const formData = new FormData(form);
                await executeFetch(url, "POST", formData);
            } catch (error) {
                showGlobalModal("error", error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });
    });
</script>
