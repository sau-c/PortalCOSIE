@{
    ViewData["Title"] = "Configuración del portal";
}
@{
    // Definimos un array de tabs para no repetir HTML
    var tabs = new[]
    {
        new { Id = "periodos", Title="Periodos", Icon="fas fa-calendar-alt", Action=Url.Action("Periodos","Configuracion")},
        new { Id = "carreras", Title="Carreras", Icon="fas fa-graduation-cap", Action=Url.Action("Carreras","Configuracion")},
        new { Id = "estadoTramite", Title="Estado trámite", Icon="fas fa-clipboard-check", Action=Url.Action("Estados","Configuracion")},
        new { Id = "estadoDocumento", Title="Estado documento", Icon="fas fa-file-alt", Action=Url.Action("EstadosDocumento","Configuracion")},
        new { Id = "tipo", Title="Tipo trámite", Icon="fas fa-tasks", Action=Url.Action("Tipo","Configuracion")}
    };
}

<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 py-1"><i class="fas fa-cogs me-2"></i>@ViewData["Title"]</h6>
    </div>
    <div class="card-body overflow-auto p-4" style="height: calc(100vh - 164px);">
        <!-- Tabs -->
        <ul class="nav nav-tabs small" id="configTabs" role="tablist">
            @foreach (var tab in tabs)
            {
                <li class="nav-item">
                    <button class="nav-link @(tab == tabs.First() ? "active" : "")"
                            data-bs-toggle="tab"
                            data-bs-target="#@tab.Id"
                            data-action="@tab.Action"
                            type="button">
                        <i class="@tab.Icon me-2"></i>@tab.Title
                    </button>
                </li>
            }
        </ul>

        <!-- Contenedores de contenido -->
        <div class="tab-content">
            @foreach (var tab in tabs)
            {
                <div class="tab-pane fade @(tab == tabs.First() ? "show active" : "")" id="@tab.Id"></div>
            }
        </div>
    </div>
</div>

<!-- Modal Genérico para Crear/Editar -->
<div class="modal fade" id="modalNombre" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="formNombre" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="hiddenNombreId" name="id" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-edit me-2"></i>
                        @* Titulo dinamico *@
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="txtNombre" class="form-label fw-semibold">
                            <i class="fas fa-tag me-1"></i>Nombre:
                        </label>
                        <input type="text" id="txtNombre" name="nombre" class="form-control" required
                               maxlength="100">
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>Máximo 100 caracteres
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button id="btnSubmitNombre" type="submit" class="btn btn-primary">
                        <i id="iconBtnNombre" class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Genérico para Toggle (Activar/Desactivar) -->
<div class="modal fade" id="modalToggle" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="formToggle" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header" id="divHdrToggle">
                    <h5 class="modal-title" id="hdrToggle">
                        <i class="fas fa-exchange-alt me-2"></i>Cambiar estado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert" id="divAlertToggle">
                        <div class="d-flex">
                            <i class="fas fa-2x me-3" id="iconToggle"></i>
                            <div>
                                <h6 class="alert-heading mb-2" id="hdrAlertTitle">@* Cambio de estado *@</h6>
                                <p id="pMessageToggle" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="fw-semibold mb-2">¿Está seguro de cambiar el estado?</p>
                        <div class="card" id="divCardToggle">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-4"><strong class="text-muted">ID:</strong></div>
                                    <div class="col-8"><span id="spanToggleId" class="fw-bold"></span></div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4"><strong class="text-muted">Nombre:</strong></div>
                                    <div class="col-8"><span id="spanToggleNombre" class="fw-bold"></span></div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4"><strong class="text-muted">Estado actual:</strong></div>
                                    <div class="col-8">
                                        <span class="badge" id="spanToggleStatus"></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-4"><strong class="text-muted">Nuevo estado:</strong></div>
                                    <div class="col-8">
                                        <span class="badge" id="spanToggleNewStatus"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="hiddenToggleId" name="id" />
                    @* <input type="hidden" id="hiddenToggleStatus"/> *@
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn" id="btnToggle">
                        <i class="fas me-1" id="iBtnToggle"></i>
                        <span id="btnToggleText">Cambiar estado</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        const modal = document.getElementById('modalNombre');
        const form = document.getElementById('formNombre');
        const boton = bloqueadorBoton(document.getElementById('btnSubmitNombre'));

        const campos = {
            id: document.getElementById('hiddenNombreId'),
            nombre: document.getElementById('txtNombre')
        };

        // Abrir modal
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.generic-edit, .generic-create');
            if (!btn) return;

            const isEdit = btn.classList.contains('generic-edit');

            // Resetear y configurar
            form.reset();
            document.getElementById('modalTitle').innerHTML = `<i class="${btn.dataset.icon || 'fas fa-edit'} me-2"></i>${btn.dataset.title || 'Crear/Editar'}`;
            form.action = btn.dataset.action || '';
            campos.id.value = isEdit ? (btn.dataset.id || '') : '';
            campos.nombre.value = isEdit ? (btn.dataset.nombre || '') : '';
            campos.nombre.placeholder = btn.dataset.placeholder || 'Ingrese el nombre';

            boton.restaurar();
            new bootstrap.Modal(modal).show();
        });

        // Submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            boton.bloquear();

            try {
                const resultado = await executeFetch(form.action, 'POST', new FormData(form));
                showGlobalModal('success', resultado.message);
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });

        // Focus al mostrar
        modal.addEventListener('shown.bs.modal', () => campos.nombre.focus());

        // Limpiar al cerrar
        modal.addEventListener('hidden.bs.modal', () => {
            form.reset();
            campos.id.value = '';
            boton.restaurar();
        });

        // Modal Genérico Toggle
        const openModalToggle = (options) => {
            const config = {
                title: 'Cambiar estado',
                action: '',
                id: '',
                name: '',
                estadoActual: '',
                ...options
            };

            if (config.estadoActual == 'False') {
                // Actualmente ACTIVO → cambiar a INACTIVO
                $('#divHdrToggle').removeClass('bg-success').addClass('bg-danger text-white');
                $('#divAlertToggle').removeClass('alert-success border-success').addClass('alert-warning border-warning');
                $('#iconToggle').removeClass('fa-check-circle text-success').addClass('fa-exclamation-triangle text-warning');
                $('#divCardToggle').removeClass('border-success').addClass('border-danger');
                $('#btnToggle').removeClass('btn-success').addClass('btn-danger');
                $('#iBtnToggle').removeClass('fa-eye').addClass('fa-eye-slash');
                $('#btnToggleText').text('Desactivar');

                $('#spanToggleStatus').removeClass('bg-danger').addClass('bg-success').text('Activo');
                $('#spanToggleNewStatus').removeClass('bg-success').addClass('bg-danger').text('Inactivo');

                $('#hdrAlertTitle').text('Desactivar registro');
                $('#pMessageToggle').text('Esta acción ocultará el registro en el sistema para acciones de creación.');
            } else {
                // Actualmente INACTIVO → cambiar a ACTIVO
                $('#divHdrToggle').removeClass('bg-danger').addClass('bg-success text-white');
                $('#divAlertToggle').removeClass('alert-warning border-warning').addClass('alert-success border-success');
                $('#iconToggle').removeClass('fa-exclamation-triangle text-warning').addClass('fa-check-circle text-success');
                $('#divCardToggle').removeClass('border-danger').addClass('border-success');
                $('#btnToggle').removeClass('btn-danger').addClass('btn-success');
                $('#iBtnToggle').removeClass('fa-eye-slash').addClass('fa-eye');
                $('#btnToggleText').text('Activar');

                $('#spanToggleStatus').removeClass('bg-success').addClass('bg-danger').text('Inactivo');
                $('#spanToggleNewStatus').removeClass('bg-danger').addClass('bg-success').text('Activo');

                $('#hdrAlertTitle').text('Activar registro');
                $('#pMessageToggle').text('Esta acción hará visible el registro en el sistema para acciones de creación.');
            }

            // Configurar datos
            $('#hdrToggle').html(`<i class="fas fa-exchange-alt me-2"></i>${config.title}`);
            $('#formToggle').attr('action', config.action);
            $('#spanToggleId').text(config.id);
            $('#spanToggleNombre').text(config.name);
            $('#hiddenToggleId').val(config.id);
            $('#hiddenToggleStatus').val(config.estadoActual);

            $('#modalToggle').modal('show');
        };
       
        $('#formToggle').on('submit', async function(e) {
            e.preventDefault();

            const form = this;
            const url = $(form).attr('action');
            const formData = new FormData(form);

            const resultado = await executeFetch(url,'POST', formData);
            if (resultado.success) {
                showGlobalModal('success', resultado.message);
                $('#modalToggle').modal('hide');
            } else {
                showGlobalModal('error', resultado.message);
            }
        });

        // Event Handlers para abrir modales
        $(document).on('click', '.generic-toggle', function() {
            const $btn = $(this);

            openModalToggle({
                title: 'Cambiar estado',
                action: $btn.data('action'),
                id: $btn.data('id'),
                name: $btn.data('name'),
                estadoActual: $btn.data('estado-actual'),
                entityName: $btn.data('entity') || 'elemento'
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const loadTabConfig = async (tabButton) => {
                const $button = $(tabButton);
                const target = $button.data('bs-target');
                const action = $button.data('action');
                const $container = $(target);

                if ($container.data('loaded')) return;

                const resultado = await executeFetch(action, 'GET', null, 'text');
                if (resultado.success) {
                    $container.html(resultado.data).data('loaded', true);
                } else {
                    $container.html('<div class="text-danger p-3">Error al cargar el contenido.</div>');
                }

            };

            // Cargar tab activo inicial
            loadTabConfig($('.nav-link.active')[0]);
            // Cargar tabs al cambiar
            $('.nav-link').on('shown.bs.tab', e => loadTabConfig(e.target));
        });
    </script>
}
