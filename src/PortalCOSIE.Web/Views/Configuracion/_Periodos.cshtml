@using PortalCOSIE.Domain.Entities.Calendario
@model PeriodoConfig

<div class="container mt-4">
    <form id="formPeriodos" asp-action="Periodos" method="post">
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0">Configuración de periodos</h6>
                    </div>
                    <div class="card-body">
                        <!-- INICIO -->
                        <fieldset class="border rounded px-3 pb-3 mb-3 bg-light">
                            <legend class="float-none w-auto px-2 text-primary fs-6">
                                <i class="fas fa-play-circle me-1"></i>Inicio
                            </legend>
                            <div class="row">
                                <div class="col-lg-6">
                                    <label class="form-label">Año:</label>
                                    <select name="anioInicio" class="form-select">
                                        @for (int año = 1995; año <= DateTime.Now.Year + 1; año++)
                                        {
                                            <option value="@año" selected="@(Model.AnioInicio == año)">@año</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label">Periodo:</label>
                                    <select name="periodoInicio" class="form-select">
                                        <option value="1" selected="@(Model.PeriodoInicio == 1)">1</option>
                                        <option value="2" selected="@(Model.PeriodoInicio == 2)">2</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>

                        <!-- FIN -->
                        <fieldset class="border rounded px-3 pb-3 mb-3 bg-light">
                            <legend class="float-none w-auto px-2 text-primary fs-6">
                                <i class="fas fa-stop-circle me-1"></i>Fin
                            </legend>
                            <div class="row">
                                <div class="col-lg-6">
                                    <label class="form-label">Año:</label>
                                    <select name="anioFin" class="form-select">
                                        @for (int año = DateTime.Now.Year; año <= DateTime.Now.Year + 1; año++)
                                        {
                                            <option value="@año" selected="@(Model.AnioFin == año)">@año</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label">Periodo:</label>
                                    <select name="periodoFin" class="form-select">
                                        <option value="1" selected="@(Model.PeriodoFin == 1)">1</option>
                                        <option value="2" selected="@(Model.PeriodoFin == 2)">2</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- VISTA PREVIA -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0">Vista previa</h6>
                    </div>
                    <div class="card-body">
                        <select id="previewSelect" class="form-select" size="10" multiple></select>
                        <small class="text-muted mt-2 d-block">
                            Total: <span id="totalPeriodos">0</span> periodos
                        </small>
                    </div>
                </div>

                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
        const form = document.getElementById('formPeriodos');
        const btnSubmit = form.querySelector('button[type="submit"]');
        const boton = bloqueadorBoton(btnSubmit);

        function generarPreview() {
            var anioInicio = parseInt($('[name="anioInicio"]').val());
            var periodoInicio = parseInt($('[name="periodoInicio"]').val());
            var anioFin = parseInt($('[name="anioFin"]').val());
            var periodoFin = parseInt($('[name="periodoFin"]').val());

            $('#previewSelect').empty();
            var total = 0;

            for (var año = anioInicio; año <= anioFin; año++) {
                var inicio = (año === anioInicio) ? periodoInicio : 1;
                var fin = (año === anioFin) ? periodoFin : 2;

                for (var periodo = inicio; periodo <= fin; periodo++) {
                    $('#previewSelect').append('<option>' + año + '/' + periodo + '</option>');
                    total++;
                }
            }
            $('#totalPeriodos').text(total);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            boton.bloquear();

            try {
                const resultado = await executeFetch(form.action, 'POST', new FormData(form));
                showGlobalModal('success', resultado.message);
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });


        $('select').on('change', generarPreview);
        generarPreview();
    });
</script>