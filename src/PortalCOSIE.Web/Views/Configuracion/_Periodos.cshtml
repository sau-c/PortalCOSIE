@model PortalCOSIE.Application.DTO.Periodo.PeriodoConfigDTO

<div class="container mt-4">
    <form id="formPeriodos" asp-action="Periodos" enctype="multipart/form-data" method="post">
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0">Configuración de periodos</h6>
                    </div>
                    <div class="card-body">
                        <!-- INICIO -->
                        <fieldset class="border rounded px-3 pb-3 mb-3 bg-light">
                            <legend class="float-none w-auto px-2 text-primary fs-6">
                                <i class="fas fa-play-circle me-1"></i>Inicio
                            </legend>
                            <div class="row">
                                <div class="col-lg-6">
                                    <label class="form-label">Año:</label>
                                    <select name="anioInicio" class="form-select">
                                        @for (int año = 1995; año <= DateTime.Now.Year + 1; año++)
                                        {
                                            <option value="@año" selected="@(Model.AnioInicio == año)">@año</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label">Periodo:</label>
                                    <select name="periodoInicio" class="form-select">
                                        <option value="1" selected="@(Model.PeriodoInicio == 1)">1</option>
                                        <option value="2" selected="@(Model.PeriodoInicio == 2)">2</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>

                        <!-- FIN -->
                        <fieldset class="border rounded px-3 pb-3 mb-3 bg-light">
                            <legend class="float-none w-auto px-2 text-primary fs-6">
                                <i class="fas fa-stop-circle me-1"></i>Actual
                            </legend>
                            <div class="row">
                                <div class="col-lg-6">
                                    <label class="form-label">Año:</label>
                                    <select name="anioActual" class="form-select">
                                        @for (int año = DateTime.Now.Year; año <= DateTime.Now.Year + 1; año++)
                                        {
                                            <option value="@año" selected="@(Model.AnioActual == año)">@año</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label">Periodo:</label>
                                    <select name="periodoActual" class="form-select">
                                        <option value="1" selected="@(Model.PeriodoActual == 1)">1</option>
                                        <option value="2" selected="@(Model.PeriodoActual == 2)">2</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- VISTA PREVIA -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0">Vista previa</h6>
                    </div>
                    <div class="card-body">
                        <select id="previewSelect" class="form-select" size="7" multiple></select>
                        <small class="text-muted mt-2 d-block">
                            Total: <span id="totalPeriodos">0</span> periodos
                        </small>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Esta lista será visible en todos los campos del sistema que la requieran. 
                            Asimismo, la configuración del período actual se utilizará para el registro 
                            de trámites, por lo que deberá actualizarse al finalizar cada ciclo escolar.
                        </div>
                    </div>
                </div>

                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
        const form = document.getElementById('formPeriodos');
        const btnSubmit = form.querySelector('button[type="submit"]');
        const boton = bloqueadorBoton(btnSubmit);

        function generarPreview() {
            var anioInicio = parseInt($('[name="anioInicio"]').val());
            var periodoInicio = parseInt($('[name="periodoInicio"]').val());
            var anioActual = parseInt($('[name="anioActual"]').val());
            var periodoActual = parseInt($('[name="periodoActual"]').val());

            $('#previewSelect').empty();
            var total = 0;

            for (var año = anioInicio; año <= anioActual; año++) {
                var inicio = (año === anioInicio) ? periodoInicio : 1;
                var fin = (año === anioActual) ? periodoActual : 2;

                for (var periodo = inicio; periodo <= fin; periodo++) {
                    $('#previewSelect').append('<option>' + año + '/' + periodo + '</option>');
                    total++;
                }
            }
            $('#totalPeriodos').text(total);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            boton.bloquear();

            try {
                const resultado = await executeFetch(form.action, 'POST', new FormData(form));
                showGlobalModal('success', resultado.message);
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });


        $('select').on('change', generarPreview);
        generarPreview();
    });
</script>