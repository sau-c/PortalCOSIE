<div class="modal fade" id="modalConfirmarAsignacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>Confirmar acción
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-primary bg-primary bg-opacity-10 d-inline-block p-3 rounded-circle">
                    <i class="fas fa-hand-holding fa-2x"></i>
                </div>
                <h5 class="fw-bold mb-2">¿Deseas tomar este trámite?</h5>
                <p class="text-muted small mb-0">
                    Al confirmar, serás asignado como el responsable de dar seguimiento a esta solicitud.
                </p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnConfirmarSi" class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Sí, asignar a mí
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // Variables locales al componente
        let formPendiente = null;
        const modalElement = document.getElementById('modalConfirmarAsignacion');

        // Verificamos que el elemento exista para evitar errores
        if(!modalElement) return;

        const modalConfirmacion = new bootstrap.Modal(modalElement);
        const btnConfirmarSi = document.getElementById('btnConfirmarSi');

        // 1. ESCUCHA GLOBAL: Intercepta cualquier formulario que empiece con "formTomar_"
        document.body.addEventListener('submit', function (e) {
            // Si el elemento que disparó el submit no tiene ID o no es de los nuestros, ignorar
            if (!e.target.id || !e.target.id.startsWith('formTomar_')) return;

            e.preventDefault();
            e.stopPropagation();

            formPendiente = e.target;
            modalConfirmacion.show();
        });

        // 2. ACCIÓN DE CONFIRMACIÓN
        btnConfirmarSi.addEventListener('click', async function () {
            if (!formPendiente) return;

            modalConfirmacion.hide();

            // Usamos tus helpers globales (bloqueadorBoton, executeFetch, showGlobalModal)
            const btnSubmitOriginal = formPendiente.querySelector('button[type="submit"]');
            const control = bloqueadorBoton(btnSubmitOriginal); // Asumo que esta fn es global

            control.bloquear();

            try {
                const url = formPendiente.action;
                const formData = new FormData(formPendiente);
                const resultado = await executeFetch(url, 'POST', formData);
                showGlobalModal('success', resultado.message);
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => control.restaurar()
                });
            }
        });
    });
</script>