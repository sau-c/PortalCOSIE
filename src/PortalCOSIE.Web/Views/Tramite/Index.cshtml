@model IEnumerable<PortalCOSIE.Domain.Entities.Tramites.Tramite>
@{
    ViewData["Title"] = "Trámites";
}

<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-0 py-1"><i class="fas fa-clipboard-list me-2"></i>@ViewData["Title"]</h6>
        </div>
    </div>

    <div class="card-body overflow-auto px-3" style="height: calc(100vh - 164px);">

        <table id="tblTramites" class="table table-hover table-sm align-middle" style="font-size: 0.9rem;">
            <thead class="table-light table-bordered">
                <tr class="small">
                    <th>Id</th>
                    <th>Solicitud</th>
                    <th>Tipo</th>
                    <th>Alumno</th>
                    <th>Personal</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Conclusión</th>
                    <th class="text-center">Acción</th>
                </tr>
            </thead>

            @foreach (var tramite in Model)
            {
                <tr>
                    <td class="text-center small fw-bold">@tramite.Id</td>
                    <td class="small text-center">
                        @tramite.FechaSolicitud.ToString("dd MMM yyyy")<br />
                        <span class="text-muted fw-bold">@tramite.PeriodoSolicitud</span>
                    </td>
                    <td class="small fw-bold text-secondary">@tramite.TipoTramite.Nombre</td>
                    <td>
                        <div class="d-flex align-items-center" style="max-width: 180px;">
                            <i class="fas fa-user-graduate text-primary me-2 opacity-50"></i>
                            <span>@tramite.Alumno.NombreCompleto()</span>
                        </div>
                    </td>

                    <td>
                        @if (tramite.PersonalId == null)
                        {
                            <span class="badge bg-secondary bg-opacity-10 text-secondary border fw-normal">
                                Sin asignar
                            </span>
                        }
                        else
                        {
                            <div class="d-flex align-items-center" style="max-width: 180px;">
                                <i class="fas fa-user-tie text-success me-2 opacity-50"></i>
                                <span>@tramite.Personal.NombreCompleto()</span>
                            </div>
                        }
                    </td>

                    <td class="text-center">
                        <span class="badge shadow-sm border border-light @tramite.EstadoTramite.ToBadgeClass()">
                            <i class="@tramite.EstadoTramite.ToIconClass() me-2"></i>
                            @tramite.EstadoTramite.Nombre
                        </span>
                    </td>
                    <td class="small text-center">
                        @(tramite.FechaConclusion?.ToString("dd MMM yyyy") ?? "-")
                    </td>

                    <td class="text-center text-nowrap">
                        @if (tramite.PersonalId == null)
                        {
                            <form asp-action="TomarTramite" asp-route-tramiteId="@tramite.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success py-0 px-2 shadow-sm" style="font-size: 0.8rem;" title="Asignarme este trámite">
                                    <i class="fas fa-hand-paper"></i>
                                </button>
                            </form>
                        }
                        else
                        {
                            <a asp-action="SeguimientoCTCE" asp-route-tramiteId="@tramite.Id" class="btn btn-sm btn-outline-primary border-0 rounded-circle" title="Revisar">
                                <i class="fas fa-eye"></i>
                            </a>
                        }
                    </td>
                </tr>
            }
        </table>

    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            new DataTable('#tblTramites', {
                language: { url: '//cdn.datatables.net/plug-ins/2.3.2/i18n/es-MX.json' },
                paging: false,
                scrollCollapse: true,
                scrollY: 'calc(100vh - 370px)',
                fixedHeader: true,
                "order": [],
                columnDefs: [
                    { targets: 0, width: "50px" },
                    { targets: 1, width: "90px" },
                    { targets: 2, width: "15%" },
                    { targets: 3, width: "20%" },
                    { targets: 4, width: "20%" },
                    { targets: 5, width: "100px", className: "text-center" },
                    { targets: 6, width: "90px", className: "text-center" },
                    { targets: 7, width: "80px", className: "text-center", orderable: false }
                ]
            });

            document.addEventListener('submit', async (e) => {
                const form = e.target.closest('.form-tomar');
                if (!form) return;
                e.preventDefault();
                e.stopPropagation();

                const btnSubmit = form.querySelector('button[type="submit"]');
                const control = bloqueadorBoton(btnSubmit);
                control.bloquear();

                try {
                    const url = form.action;
                    const formData = new FormData(form);
                    const resultado = await executeFetch(url, 'POST', formData);
                    showGlobalModal('success', resultado.message);
                } catch (error) {
                    showGlobalModal('error', error.message, {
                        onClose: () => control.restaurar()
                    });
                }
            });

        });
    </script>
}
