@model PortalCOSIE.Application.DTO.Usuario.AlumnoCompletoDTO
@{
    ViewData["Title"] = "Mi cuenta";
}

<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 py-1"><i class="fas fa-user me-2"></i>@ViewData["Title"]</h6>
    </div>

    <div class="card-body p-4 overflow-auto" style="height: calc(100vh - 164px);">
        <!-- Información general -->
        <div class="row g-4">

            <!-- Datos personales -->
            <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-user me-2"></i>
                            Datos personales
                        </h6>
                    </div>

                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-user-circle text-primary fs-1 me-3"></i>
                            <div>
                                <h5 class="mb-0 fw-semibold">
                                    @Model.Nombre @Model.ApellidoPaterno @Model.ApellidoMaterno
                                </h5>
                                <small class="text-muted">Alumno</small>
                            </div>
                        </div>

                        <hr>

                        <h6 class="fw-bold text-secondary mb-3">Datos de contacto</h6>
                        <ul class="list-unstyled small">
                            <li class="mb-2 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <strong class="me-1">Correo:</strong>@Model.Correo
                                </div>
                                <span class="badge rounded-pill d-flex align-items-center gap-1 @(Model.CorreoConfirmado ? "bg-success text-white" : "bg-warning text-dark")">
                                    <i class="fas @(Model.CorreoConfirmado ? "fa-check-circle" : "fa-exclamation-circle")"></i>
                                    @(Model.CorreoConfirmado ? "Confirmado" : "No confirmado")
                                </span>
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-phone text-success me-1"></i>
                                <strong class="me-1">Celular:</strong>@Model.Celular
                            </li>
                        </ul>
                        <div class="d-grid mt-3">
                            <button class="btn btn-primary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalContrasena">
                                <i class="fas fa-key me-2"></i>Cambiar contraseña
                            </button>
                        </div>
                        <div class="alert alert-info mt-3 mb-0 small">
                            <i class="fas fa-info-circle me-2"></i>
                            Para modificar otros datos, acude a gestión escolar.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información académica -->
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <!-- HEADER -->
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Información académica
                        </h6>
                    </div>

                    <div class="card-body px-4">

                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-3 bg-light">
                                    <small class="text-muted">Número de Boleta</small>
                                    <h6 class="fw-bold mb-0">@Model.NumeroBoleta</h6>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-3 bg-light">
                                    <small class="text-muted">Periodo de Ingreso</small>
                                    <h6 class="fw-bold mb-0">@Model.PeriodoIngreso</h6>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-3 bg-light">
                                    <small class="text-muted">Carrera</small>
                                    <h6 class="fw-bold mb-0">@Model.Carrera.Nombre</h6>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="p-3 border rounded-3 bg-light">
                                    <small class="text-muted">Estatus</small>
                                    <h6 class="fw-bold mb-0 text-success">Activo</h6>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <h6 class="fw-bold text-secondary mb-3">Opciones</h6>

                        <div class="d-flex flex-wrap gap-2">
                            <a href="#" class="btn btn-outline-secondary btn-sm disabled">
                                <i class="fas fa-file-alt me-2"></i>
                                Descargar todos mis documentos(próximamente)
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalContrasena" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">

            <div class="modal-header bg-primary text-white">
                <h6 class="modal-title">
                    <i class="fas fa-key me-2"></i>Cambiar contraseña
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formContrasena" asp-action="CambiarContrasena" method="post">
                <div class="modal-body px-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for=@Model.IdentityUserId />
                    <!-- Contraseña actual -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Contraseña actual</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" name="contrasena" class="form-control" required />
                        </div>
                    </div>

                    <!-- Nueva contraseña -->
                    <div class="mb-1">
                        <label class="form-label fw-semibold">Nueva contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input type="password" id="nuevaContrasena" name="nuevaContrasena" class="form-control" minlength="8" required />
                        </div>

                        <!-- REQUISITOS DE IDENTITY -->
                        <small class="text-muted d-block mt-2">
                            <ul>
                                <li>Mínimo 8 caracteres.</li>
                                <li>Al menos una letra en mayúscula.</li>
                                <li>Al menos una letra en minúscula.</li>
                                <li>Al menos un número.</li>
                                <li>Al menos un carácter especial (<code>. ! @@ # $ % ^ & *</code>, etc.).</li>
                            </ul>
                        </small>
                    </div>

                    <!-- Confirmación -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Confirmar nueva contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-check"></i></span>
                            <input type="password" id="confirmarContrasena" name="confirmarContrasena" class="form-control" minlength="8" required />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button id="btnSubmitContrasena" type="submit" class="btn btn-primary">
                        <i class="fas fa-key me-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('modalContrasena');
        const form = document.getElementById('formContrasena');
        const btnSubmit = document.getElementById('btnSubmitContrasena');
        const boton = bloqueadorBoton(btnSubmit);

        const nuevaContrasena = document.getElementById('nuevaContrasena');
        const confirmarContrasena = document.getElementById('confirmarContrasena');

        // Al abrir modal
        modal.addEventListener("show.bs.modal", () => {
            form.reset();
            boton.restaurar();
        });

        // Envío asincrónico
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (nuevaContrasena.value.trim() !== confirmarContrasena.value.trim()) {
                confirmarContrasena.setAttribute('title', 'Las contraseñas no coinciden');
                if (bootstrap?.Tooltip) {
                    const tooltip = new bootstrap.Tooltip(confirmarContrasena);
                    tooltip.show();
                }
                confirmarContrasena.focus();
                return;
            }

            boton.bloquear();
            try {
                const formData = new FormData(form);
                const data = await executeFetch(form.action, 'POST', formData);
                showGlobalModal('success', data.message, {
                    autoClose: false
                });
            } catch (error) {
                showGlobalModal('error', error.message, {
                    onClose: () => boton.restaurar()
                });
            }
        });

        // Al cerrar modal
        modal.addEventListener('hidden.bs.modal', () => {
            form.reset();
            boton.restaurar();
        });
    });
</script>
